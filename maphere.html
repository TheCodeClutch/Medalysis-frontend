<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <!-- HERE JavaScript Libs & Style Sheets-->
    <link
      rel="stylesheet"
      type="text/css"
      href="https://js.api.here.com/v3/3.1/mapsjs-ui.css"
    />
    <script
      type="text/javascript"
      src="https://js.api.here.com/v3/3.1/mapsjs-core.js"
    ></script>
    <script
      type="text/javascript"
      src="https://js.api.here.com/v3/3.1/mapsjs-service.js"
    ></script>
    <script
      type="text/javascript"
      src="https://js.api.here.com/v3/3.1/mapsjs-ui.js"
    ></script>
    <script
      type="text/javascript"
      src="https://js.api.here.com/v3/3.1/mapsjs-mapevents.js"
    ></script>
    <!-- HERE JavaScript Libs & Style Sheets end-->
    <title>HERE Map with Custom Marker</title>
  </head>

  <body>
    <!-- HTML for filters section -->

    <div class="container-fluid">
      <div class="row" style="padding-top: 30px">
        <!-- Gender -->
        <div class="col-lg-2">
          <div class="dropdown" style="padding-top: 20px">
            <select class="form-control gender-btn" id="gender">
              <option value="" selected disabled hidden>Gender</option>
              <option value="Male">Male</option>
              <option value="Female">Female</option>
              <option value="Other">Other</option>
            </select>
          </div>
        </div>

        <!-- Age -->
        <div class="col-lg-2">
          <div class="dropdown" style="padding-top: 20px">
            <select class="form-control gender-btn" id="age">
              <option value="" selected disabled hidden>Age</option>
              <option value="0-10">0-10</option>
              <option value="11-20">11-20</option>
              <option value="21-30">21-30</option>
              <option value="31-40">31-40</option>
              <option value="41-50">41-50</option>
              <option value="51-60">51-60</option>
              <option value="61-70">61-70</option>
              <option value="71-80">71-80</option>
              <option value="81-90">81-90</option>
              <option value="91-100">91-100</option>
              <option value="101-500">100+</option>
            </select>
          </div>
        </div>

        <!-- Severity -->
        <div class="col-lg-2">
          <div class="dropdown" style="padding-top: 20px">
            <select class="form-control gender-btn" id="severity">
              <option value="" selected disabled hidden>Severity</option>
              <option value="Low">Low</option>
              <option value="Medium">Medium</option>
              <option value="High">High</option>
            </select>
          </div>
        </div>

        <!-- Symptoms -->
        <div class="col-lg-2">
          <div class="dropdown" style="padding-top: 20px">
            <input list="symptoms-list" type="text" id="symptoms" autocomplete>
            <datalist id="symptoms-list">

            </datalist>
          </div>
        </div>

        <!-- Organs -->
        <div class="col-2">
          <div class="dropdown" style="padding-top: 21px">
            <select class="form-control organ-btn" id="organ">
              <option value="" selected disabled hidden>
                Disease related to*
              </option>
              <option>Brain</option>
              <option>Lungs</option>
              <option>Heart</option>
              <option>Kidney</option>
              <option>Liver</option>
              <option>Stomach</option>
              <option>ENT(Ear/Nose/Throat)</option>
              <option>Multiple/Other</option>
            </select>
          </div>
        </div>

        <!-- Country -->
        <select name="country" class="countries order-alpha" id="countryId">
          <option value="">Select Country</option>
        </select>
        <select
          name="state"
          class="states order-alpha"
          id="stateId"
          style="display: none"
        >
          <option value="">Select State</option>
        </select>

        <!-- Date - From -->
        <div class="col-2">
            <input type="number" id="year" min="1900" max="2099" step="1" value="2016" />
        </div>

      </div>
    </div>

    <button id="filter-apply">Filter apply</button>

    <!--In the div HERE Map will be rendered-->
    <div style="width: 100vw; height: 100vh" id="mapContainer"></div>
    <script>

        let globalMarkers = []


        function autoComplete(arr){
            console.log(arr)
            let html = ``
            arr.forEach(ele => {
                html += `<option value="${ele.SYMPTOMS}">`
            })
            document.getElementById("symptoms-list").innerHTML = html;
        }


        document.getElementById('symptoms').addEventListener('input', () => {
            const val = document.getElementById('symptoms').value
            fetch(`https://medalysis.herokuapp.com/core/search?q=${val}`)
                .then(res => res.json())
                .then(res => {
                    res = res.message
                    autoComplete(res)
                })
                .catch(err => {
                    console.log(err)
                })
        })



      //Step 1: initialize communication with the platform
      // Replace variable YOUR_API_KEY with your own apikey
      var platform = new H.service.Platform({
        apikey: "xbqJf0CbbX0ii8M-HdaLIQJiGAWkZLYM2DmFG8hMlM8",
      });
      var defaultLayers = platform.createDefaultLayers();
      //Step 2: initialize a map - this map is centered over Europe
      var map = new H.Map(
        document.getElementById("mapContainer"),
        defaultLayers.vector.normal.map,
        {
          center: { lat: 50, lng: 5 },
          zoom: 1,
          pixelRatio: window.devicePixelRatio || 1,
        }
      );
      // This adds a resize listener to make sure that the map occupies the whole container
      window.addEventListener("resize", () => map.getViewPort().resize());
      //Step 3: make the map interactive
      // MapEvents enables the event system
      // Behavior implements default interactions for pan/zoom (also on mobile touch environments)
      var behavior = new H.mapevents.Behavior(new H.mapevents.MapEvents(map));

      // Create the default UI components
      var ui = H.ui.UI.createDefault(map, defaultLayers);

      fetch("https://medalysis.herokuapp.com/core/get/data")
        .then((res) => res.json())
        .then((res) => {
          const arr = res.message;
          arr.forEach((ele) => {
            var LocationOfMarker = { lat: ele.LATITUDE, lng: ele.LONGITUDE };

            // optionally - resize a larger PNG image to a specific size
            var pngIcon = new H.map.Icon(
              "https://cdn3.iconfinder.com/data/icons/tourism/eiffel200.png",
              { size: { w: 56, h: 56 } }
            );

            // Create a marker using the previously instantiated icon:
            var marker = new H.map.Marker(LocationOfMarker, { icon: pngIcon });

            // Add the marker to the map:
            map.addObject(marker);
            globalMarkers.push(marker)
          });
          console.log(res);
        });

      document.getElementById("filter-apply").addEventListener("click", () => {
        let ageFrom;
        let ageTo;
        if(document.getElementById("age").value.split("-")[0]){
            ageFrom = document.getElementById("age").value.split("-")[0];
            ageTo = document.getElementById("age").value.split("-")[1];
        }
        const gender = document.getElementById("gender").value;

        const organ = document.getElementById("organ").value;
        const severity = document.getElementById("severity").value;
        const symptoms = document.getElementById("symptoms").value;

        const country = document.getElementById("countryId").value;
        const year = document.getElementById("year").value;

        let url = `https://medalysis.herokuapp.com/core/get/filterdata?`;
        if (gender.trim().length > 0) {
          url = url + `gender=${gender}`;
        }
        if (severity.trim().length > 0) {
          url = url + `&severity=${severity}`;
        }
        if (symptoms.trim().length > 0) {
          url = url + `&symptoms=${symptoms}`;
        }
        if (country.trim().length > 0) {
          url = url + `&country=${country}`;
        }
        if (ageFrom && ageFrom.trim().length > 0) {
          url = url + `&ageFrom=${ageFrom}`;
        }
        if (ageTo && ageTo.trim().length > 0) {
          url = url + `&ageTo=${ageTo}`;
        }
        if (year.trim().length > 0) {
          url = url + `&year=${year}`;
        }

        console.log(url);

          fetch(url)
            .then((res) => res.json())
            .then((res) => {
            globalMarkers.length > 0 ? map.removeObjects(globalMarkers) : null;
              const arr = res.message;
              arr.forEach((ele) => {
                var LocationOfMarker = { lat: ele.LATITUDE, lng: ele.LONGITUDE };

                // optionally - resize a larger PNG image to a specific size
                var pngIcon = new H.map.Icon(
                  "https://cdn3.iconfinder.com/data/icons/tourism/eiffel200.png",
                  { size: { w: 56, h: 56 } }
                );

                // Create a marker using the previously instantiated icon:
                var marker = new H.map.Marker(LocationOfMarker, { icon: pngIcon });

                // Add the marker to the map:
                map.addObject(marker);
                globalMarkers.push(marker)
              });
              console.log(res);
            })
            .catch((err) => {
              console.log(err);
            });
      });
    </script>

    <!-- Geodata.solutions -->
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <script src="//geodata.solutions/includes/countrystate.js"></script>
  </body>
</html>
